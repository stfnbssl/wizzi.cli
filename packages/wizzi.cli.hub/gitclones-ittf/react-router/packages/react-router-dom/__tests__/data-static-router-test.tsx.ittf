module
    import 
        as React
        from "react"
        #
            # *
            # * @jest-environment node
            # 
    import 
        as ReactDOMServer
        from "react-dom/server"
    import 
        @ json
        from "@remix-run/router"
    import 
        @ Form
        @ Link
        @ Outlet
        @ useLoaderData
        @ useLocation
        @ useMatches
        from "react-router-dom"
    :import-type 
        @ StaticHandlerContext
        from "react-router-dom/server"
    import 
        @ createStaticHandler
        @ createStaticRouter
        @ StaticRouterProvider
        from "react-router-dom/server"
    _ beforeEach
        => 
            _ jest.spyOn(console, "warn").mockImplementation
                => 
            _ jest.spyOn(console, "error").mockImplementation
                => 
    _ describe
        @ "A <StaticRouterProvider>"
        => 
            _ it
                @ "renders an initialized router"
                async=> 
                    let hooksData1
                        :{ 
                            :p location
                                :ref ReturnType
                                    :param 
                                        :typeof useLocation
                            :p loaderData
                                :ref ReturnType
                                    :param 
                                        :typeof useLoaderData
                            :p matches
                                :ref ReturnType
                                    :param 
                                        :typeof useMatches
                    let hooksData2
                        :{ 
                            :p location
                                :ref ReturnType
                                    :param 
                                        :typeof useLocation
                            :p loaderData
                                :ref ReturnType
                                    :param 
                                        :typeof useLoaderData
                            :p matches
                                :ref ReturnType
                                    :param 
                                        :typeof useMatches
                    function HooksChecker1
                        set hooksData1 =
                            { 
                                @ location useLocation()
                                @ loaderData useLoaderData()
                                @ matches useMatches()
                        return 
                            < Outlet 
                    function HooksChecker2
                        set hooksData2 =
                            { 
                                @ location useLocation()
                                @ loaderData useLoaderData()
                                @ matches useMatches()
                        return 
                            < React.Fragment
                                h1 
                                    + ðŸ‘‹
                                < Link 
                                    @ to "/the/other/path"
                                    + Other
                    let routes
                        [ 
                            { 
                                @ path "the"
                                @ loader
                                    => 
                                        (
                                            { 
                                                @ key1 "value1"
                                @ element
                                    < HooksChecker1 
                                @ handle "1"
                                [ children
                                    { 
                                        @ path "path"
                                        @ loader
                                            => 
                                                (
                                                    { 
                                                        @ key2 "value2"
                                        @ element
                                            < HooksChecker2 
                                        @ handle "2"
                    let 
                        { 
                            @ query
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/the/path?the=query#the-hash"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(routes, context)}
                                    @ context {context}
                    _ expect(html).toMatch("<h1>ðŸ‘‹</h1>")
                    _ expect(html).toMatch('<a href="/the/other/path">')
                        # @ts-expect-error
                    _ expect(hooksData1.location).toEqual
                        { 
                            @ pathname "/the/path"
                            @ search "?the=query"
                            @ hash "#the-hash"
                            @ state null
                            @ key expect.any(String)
                        # @ts-expect-error
                        # @ts-expect-error
                    _ expect(hooksData1.loaderData).toEqual
                        { 
                            @ key1 "value1"
                        # @ts-expect-error
                        # @ts-expect-error
                    _ expect(hooksData1.matches).toEqual
                        [ 
                            { 
                                { data
                                    @ key1 "value1"
                                @ handle "1"
                                @ id "0"
                                { params
                                @ pathname "/the"
                            { 
                                { data
                                    @ key2 "value2"
                                @ handle "2"
                                @ id "0-0"
                                { params
                                @ pathname "/the/path"
                        # @ts-expect-error
                        # @ts-expect-error
                    _ expect(hooksData2.location).toEqual
                        { 
                            @ pathname "/the/path"
                            @ search "?the=query"
                            @ hash "#the-hash"
                            @ state null
                            @ key expect.any(String)
                        # @ts-expect-error
                        # @ts-expect-error
                    _ expect(hooksData2.loaderData).toEqual
                        { 
                            @ key2 "value2"
                        # @ts-expect-error
                        # @ts-expect-error
                    _ expect(hooksData2.matches).toEqual
                        [ 
                            { 
                                { data
                                    @ key1 "value1"
                                @ handle "1"
                                @ id "0"
                                { params
                                @ pathname "/the"
                            { 
                                { data
                                    @ key2 "value2"
                                @ handle "2"
                                @ id "0-0"
                                { params
                                @ pathname "/the/path"
                        # @ts-expect-error
            _ it
                @ "renders an initialized router with lazy routes"
                async=> 
                    let hooksData1
                        :{ 
                            :p location
                                :ref ReturnType
                                    :param 
                                        :typeof useLocation
                            :p loaderData
                                :ref ReturnType
                                    :param 
                                        :typeof useLoaderData
                            :p matches
                                :ref ReturnType
                                    :param 
                                        :typeof useMatches
                    let hooksData2
                        :{ 
                            :p location
                                :ref ReturnType
                                    :param 
                                        :typeof useLocation
                            :p loaderData
                                :ref ReturnType
                                    :param 
                                        :typeof useLoaderData
                            :p matches
                                :ref ReturnType
                                    :param 
                                        :typeof useMatches
                    function HooksChecker1
                        set hooksData1 =
                            { 
                                @ location useLocation()
                                @ loaderData useLoaderData()
                                @ matches useMatches()
                        return 
                            < Outlet 
                    function HooksChecker2
                        set hooksData2 =
                            { 
                                @ location useLocation()
                                @ loaderData useLoaderData()
                                @ matches useMatches()
                        return 
                            < React.Fragment
                                h1 
                                    + ðŸ‘‹
                                < Link 
                                    @ to "/the/other/path"
                                    + Other
                    let routes
                        [ 
                            { 
                                @ path "the"
                                @ lazy
                                    async=> 
                                        (
                                            { 
                                                @ loader
                                                    => 
                                                        (
                                                            { 
                                                                @ key1 "value1"
                                                @ element
                                                    < HooksChecker1 
                                                @ handle "1"
                                [ children
                                    { 
                                        @ path "path"
                                        @ lazy
                                            async=> 
                                                (
                                                    { 
                                                        @ loader
                                                            => 
                                                                (
                                                                    { 
                                                                        @ key2 "value2"
                                                        @ element
                                                            < HooksChecker2 
                                                        @ handle "2"
                    let 
                        { 
                            @ query
                            @ dataRoutes
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/the/path?the=query#the-hash"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(dataRoutes, context)}
                                    @ context {context}
                    _ expect(html).toMatch("<h1>ðŸ‘‹</h1>")
                    _ expect(html).toMatch('<a href="/the/other/path">')
                        # @ts-expect-error
                    _ expect(hooksData1.location).toEqual
                        { 
                            @ pathname "/the/path"
                            @ search "?the=query"
                            @ hash "#the-hash"
                            @ state null
                            @ key expect.any(String)
                        # @ts-expect-error
                        # @ts-expect-error
                    _ expect(hooksData1.loaderData).toEqual
                        { 
                            @ key1 "value1"
                        # @ts-expect-error
                        # @ts-expect-error
                    _ expect(hooksData1.matches).toEqual
                        [ 
                            { 
                                { data
                                    @ key1 "value1"
                                @ handle "1"
                                @ id "0"
                                { params
                                @ pathname "/the"
                            { 
                                { data
                                    @ key2 "value2"
                                @ handle "2"
                                @ id "0-0"
                                { params
                                @ pathname "/the/path"
                        # @ts-expect-error
                        # @ts-expect-error
                    _ expect(hooksData2.location).toEqual
                        { 
                            @ pathname "/the/path"
                            @ search "?the=query"
                            @ hash "#the-hash"
                            @ state null
                            @ key expect.any(String)
                        # @ts-expect-error
                        # @ts-expect-error
                    _ expect(hooksData2.loaderData).toEqual
                        { 
                            @ key2 "value2"
                        # @ts-expect-error
                        # @ts-expect-error
                    _ expect(hooksData2.matches).toEqual
                        [ 
                            { 
                                { data
                                    @ key1 "value1"
                                @ handle "1"
                                @ id "0"
                                { params
                                @ pathname "/the"
                            { 
                                { data
                                    @ key2 "value2"
                                @ handle "2"
                                @ id "0-0"
                                { params
                                @ pathname "/the/path"
                        # @ts-expect-error
            _ it
                @ "renders an initialized router with a basename"
                async=> 
                    let location
                        :ref ReturnType
                            :param 
                                :typeof useLocation
                    function GetLocation
                        set location = useLocation()
                        return 
                            < React.Fragment
                                h1 
                                    + ðŸ‘‹
                                < Link 
                                    @ to "/the/other/path"
                                    + Other
                    let routes
                        [ 
                            { 
                                @ path "the"
                                [ children
                                    { 
                                        @ path "path"
                                        @ element
                                            < GetLocation 
                    let 
                        { 
                            @ query
                        =
                            _ createStaticHandler
                                @ routes
                                { 
                                    @ basename "/base"
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/base/the/path?the=query#the-hash"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(routes, context)}
                                    @ context {context}
                    _ expect(html).toMatch("<h1>ðŸ‘‹</h1>")
                    _ expect(html).toMatch('<a href="/base/the/other/path">')
                        # @ts-expect-error
                    _ expect(location).toEqual
                        { 
                            @ pathname "/the/path"
                            @ search "?the=query"
                            @ hash "#the-hash"
                            @ state null
                            @ key expect.any(String)
                        # @ts-expect-error
            _ it
                @ "renders hydration data by default"
                async=> 
                    let routes
                        [ 
                            { 
                                @ id "the"
                                    # provide unique id here but not below, to ensure we add where needed
                                @ path "the"
                                @ loader
                                    => 
                                        (
                                            { 
                                                @ key1 "value1"
                                @ element
                                    < Outlet 
                                [ children
                                    { 
                                        @ path "path"
                                        @ loader
                                            => 
                                                (
                                                    { 
                                                        @ key2 "value2"
                                        @ element
                                            h1 
                                                + ðŸ‘‹
                    let 
                        { 
                            @ query
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/the/path"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(routes, context)}
                                    @ context {context}
                    _ expect(html).toMatch("<h1>ðŸ‘‹</h1>")
                    let expectedJsonString
                        _ JSON.stringify
                            _ JSON.stringify
                                { 
                                    { loaderData
                                        { the
                                            @ key1 "value1"
                                        { "0-0"
                                            @ key2 "value2"
                                    @ actionData null
                                    @ errors null
                    _ expect(html).toMatch
                        `lit 
                            + <script>window.__staticRouterHydrationData = JSON.parse(
                            @ expectedJsonString
                            + );</script>
            _ it
                @ "renders hydration data from lazy routes by default"
                async=> 
                    let routes
                        [ 
                            { 
                                @ id "the"
                                    # provide unique id here but not below, to ensure we add where needed
                                @ path "the"
                                @ lazy
                                    async=> 
                                        (
                                            { 
                                                @ loader
                                                    => 
                                                        (
                                                            { 
                                                                @ key1 "value1"
                                                @ element
                                                    < Outlet 
                                [ children
                                    { 
                                        @ path "path"
                                        @ lazy
                                            async=> 
                                                (
                                                    { 
                                                        @ loader
                                                            => 
                                                                (
                                                                    { 
                                                                        @ key2 "value2"
                                                        @ element
                                                            h1 
                                                                + ðŸ‘‹
                    let 
                        { 
                            @ query
                            @ dataRoutes
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/the/path"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(dataRoutes, context)}
                                    @ context {context}
                    _ expect(html).toMatch("<h1>ðŸ‘‹</h1>")
                    let expectedJsonString
                        _ JSON.stringify
                            _ JSON.stringify
                                { 
                                    { loaderData
                                        { the
                                            @ key1 "value1"
                                        { "0-0"
                                            @ key2 "value2"
                                    @ actionData null
                                    @ errors null
                    _ expect(html).toMatch
                        `lit 
                            + <script>window.__staticRouterHydrationData = JSON.parse(
                            @ expectedJsonString
                            + );</script>
            _ it
                @ "escapes HTML tags in serialized hydration data"
                async=> 
                    let routes
                        [ 
                            { 
                                @ path "/"
                                @ loader
                                    => 
                                        (
                                            { 
                                                @ key "uh </script> oh"
                                @ element
                                    h1 
                                        + ðŸ‘‹
                    let 
                        { 
                            @ query
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(routes, context)}
                                    @ context {context}
                    _ expect(html).toMatchInlineSnapshot
                        `lit 
                            + "<h1>ðŸ‘‹</h1><script>window.__staticRouterHydrationData = JSON.parse("{\\"loaderData\\":{\\"0\\":{\\"key\\":\\"uh \\u003c/script\\u003e oh\\"}},\\"actionData\\":null,\\"errors\\":null}");</script>"
            _ it
                @ "encodes auto-generated <a href> values to avoid hydration errors"
                async=> 
                    let routes
                        [ 
                            { 
                                @ path "/path/:param"
                                @ element
                                    < Link 
                                        @ to "."
                                        + ðŸ‘‹
                    let 
                        { 
                            @ query
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/path/with space"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(routes, context)}
                                    @ context {context}
                    _ expect(html).toContain('<a href="/path/with%20space">ðŸ‘‹</a>')
            _ it
                @ "does not encode user-specified <a href> values"
                async=> 
                    let routes
                        [ 
                            { 
                                @ path "/"
                                @ element
                                    < Link 
                                        @ to "/path/with space"
                                        + ðŸ‘‹
                    let 
                        { 
                            @ query
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(routes, context)}
                                    @ context {context}
                    _ expect(html).toContain('<a href="/path/with space">ðŸ‘‹</a>')
            _ it
                @ "encodes auto-generated <form action> values to avoid hydration errors (action=undefined)"
                async=> 
                    let routes
                        [ 
                            { 
                                @ path "/path/:param"
                                @ element
                                    < Form 
                                        + ðŸ‘‹
                    let 
                        { 
                            @ query
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/path/with space"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(routes, context)}
                                    @ context {context}
                    _ expect(html).toContain('<form method="get" action="/path/with%20space">ðŸ‘‹</form>')
            _ it
                @ 'encodes auto-generated <form action> values to avoid hydration errors (action=".")'
                async=> 
                    let routes
                        [ 
                            { 
                                @ path "/path/:param"
                                @ element
                                    < Form 
                                        @ action "."
                                        + ðŸ‘‹
                    let 
                        { 
                            @ query
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/path/with space"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(routes, context)}
                                    @ context {context}
                    _ expect(html).toContain('<form method="get" action="/path/with%20space">ðŸ‘‹</form>')
            _ it
                @ "does not encode user-specified <form action> values"
                async=> 
                    let routes
                        [ 
                            { 
                                @ path "/"
                                @ element
                                    < Form 
                                        @ action "/path/with space"
                                        + ðŸ‘‹
                    let 
                        { 
                            @ query
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(routes, context)}
                                    @ context {context}
                    _ expect(html).toContain('<form method="get" action="/path/with space">ðŸ‘‹</form>')
            _ it
                @ "serializes ErrorResponse instances"
                async=> 
                    let routes
                        [ 
                            { 
                                @ path "/"
                                @ loader
                                    => 
                                        throw 
                                            _ json
                                                { 
                                                    @ not "found"
                                                { 
                                                    @ status 404
                                                    @ statusText "Not Found"
                    let 
                        { 
                            @ query
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(routes, context)}
                                    @ context {context}
                    let expectedJsonString
                        _ JSON.stringify
                            _ JSON.stringify
                                { 
                                    { loaderData
                                    @ actionData null
                                    { errors
                                        { "0"
                                            @ status 404
                                            @ statusText "Not Found"
                                            @ internal false
                                            { data
                                                @ not "found"
                                            @ __type "RouteErrorResponse"
                    _ expect(html).toMatch
                        `lit 
                            + <script>window.__staticRouterHydrationData = JSON.parse(
                            @ expectedJsonString
                            + );</script>
            _ it
                @ "serializes ErrorResponse instances from lazy routes"
                async=> 
                    let routes
                        [ 
                            { 
                                @ path "/"
                                @ lazy
                                    async=> 
                                        (
                                            { 
                                                @ loader
                                                    => 
                                                        throw 
                                                            _ json
                                                                { 
                                                                    @ not "found"
                                                                { 
                                                                    @ status 404
                                                                    @ statusText "Not Found"
                    let 
                        { 
                            @ query
                            @ dataRoutes
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(dataRoutes, context)}
                                    @ context {context}
                    let expectedJsonString
                        _ JSON.stringify
                            _ JSON.stringify
                                { 
                                    { loaderData
                                    @ actionData null
                                    { errors
                                        { "0"
                                            @ status 404
                                            @ statusText "Not Found"
                                            @ internal false
                                            { data
                                                @ not "found"
                                            @ __type "RouteErrorResponse"
                    _ expect(html).toMatch
                        `lit 
                            + <script>window.__staticRouterHydrationData = JSON.parse(
                            @ expectedJsonString
                            + );</script>
            _ it
                @ "serializes Error instances"
                async=> 
                    let routes
                        [ 
                            { 
                                @ path "/"
                                @ loader
                                    => 
                                        throw new Error("oh no")
                    let 
                        { 
                            @ query
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(routes, context)}
                                    @ context {context}
                        # stack is stripped by default from SSR errors
                    let expectedJsonString
                        _ JSON.stringify
                            _ JSON.stringify
                                { 
                                    { loaderData
                                    @ actionData null
                                    { errors
                                        { "0"
                                            @ message "oh no"
                                            @ __type "Error"
                        # stack is stripped by default from SSR errors
                    _ expect(html).toMatch
                        `lit 
                            + <script>window.__staticRouterHydrationData = JSON.parse(
                            @ expectedJsonString
                            + );</script>
            _ it
                @ "serializes Error instances from lazy routes"
                async=> 
                    let routes
                        [ 
                            { 
                                @ path "/"
                                @ lazy
                                    async=> 
                                        (
                                            { 
                                                @ loader
                                                    => 
                                                        throw new Error("oh no")
                    let 
                        { 
                            @ query
                            @ dataRoutes
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(dataRoutes, context)}
                                    @ context {context}
                        # stack is stripped by default from SSR errors
                    let expectedJsonString
                        _ JSON.stringify
                            _ JSON.stringify
                                { 
                                    { loaderData
                                    @ actionData null
                                    { errors
                                        { "0"
                                            @ message "oh no"
                                            @ __type "Error"
                        # stack is stripped by default from SSR errors
                    _ expect(html).toMatch
                        `lit 
                            + <script>window.__staticRouterHydrationData = JSON.parse(
                            @ expectedJsonString
                            + );</script>
            _ it
                @ "serializes Error subclass instances"
                async=> 
                    let routes
                        [ 
                            { 
                                @ path "/"
                                @ loader
                                    => 
                                        throw new ReferenceError("oh no")
                    let 
                        { 
                            @ query
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(routes, context)}
                                    @ context {context}
                        # stack is stripped by default from SSR errors
                    let expectedJsonString
                        _ JSON.stringify
                            _ JSON.stringify
                                { 
                                    { loaderData
                                    @ actionData null
                                    { errors
                                        { "0"
                                            @ message "oh no"
                                            @ __type "Error"
                                            @ __subType "ReferenceError"
                        # stack is stripped by default from SSR errors
                    _ expect(html).toMatch
                        `lit 
                            + <script>window.__staticRouterHydrationData = JSON.parse(
                            @ expectedJsonString
                            + );</script>
            _ it
                @ "supports a nonce prop"
                async=> 
                    let routes
                        [ 
                            { 
                                @ path "the"
                                @ element
                                    < Outlet 
                                [ children
                                    { 
                                        @ path "path"
                                        @ element
                                            h1 
                                                + ðŸ‘‹
                    let 
                        { 
                            @ query
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/the/path"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(routes, context)}
                                    @ context {context}
                                    @ nonce "nonce-string"
                    _ expect(html).toMatch("<h1>ðŸ‘‹</h1>")
                    let expectedJsonString
                        _ JSON.stringify
                            _ JSON.stringify
                                { 
                                    { loaderData
                                        @ 0 null
                                        @ "0-0" null
                                    @ actionData null
                                    @ errors null
                    _ expect(html).toMatch
                        `lit 
                            + <script nonce="nonce-string">window.__staticRouterHydrationData = JSON.parse(
                            @ expectedJsonString
                            + );</script>
            _ it
                @ "allows disabling of automatic hydration"
                async=> 
                    let routes
                        [ 
                            { 
                                @ path "the"
                                @ loader
                                    => 
                                        (
                                            { 
                                                @ key1 "value1"
                                @ element
                                    < Outlet 
                                [ children
                                    { 
                                        @ path "path"
                                        @ loader
                                            => 
                                                (
                                                    { 
                                                        @ key2 "value2"
                                        @ element
                                            h1 
                                                + ðŸ‘‹
                    let 
                        { 
                            @ query
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/the/path"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(routes, context)}
                                    @ context {context}
                                    @ hydrate {false}
                    _ expect(html).toMatch("<h1>ðŸ‘‹</h1>")
                    _ expect(html).not.toMatch("<script>")
                    _ expect(html).not.toMatch("window")
                    _ expect(html).not.toMatch("__staticRouterHydrationData")
            _ it
                @ "errors if required props are not passed"
                async=> 
                    let routes
                        [ 
                            { 
                                @ path ""
                                @ element
                                    h1 
                                        + ðŸ‘‹
                    let 
                        { 
                            @ query
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    _ expect
                        => 
                            _ ReactDOMServer.renderToStaticMarkup
                                < React.StrictMode 
                                    { 
                                        # 
                                            # @ts-expect-error
                                    < StaticRouterProvider 
                                        @ context {context}
                        ._ toThrowErrorMatchingInlineSnapshot
                            `lit 
                                + "You must provide \`router\` and \`context\` to <StaticRouterProvider>"
                    _ expect
                        => 
                            _ ReactDOMServer.renderToStaticMarkup
                                < React.StrictMode 
                                    { 
                                        # 
                                            # @ts-expect-error
                                    < StaticRouterProvider 
                                        @ router {createStaticRouter(routes, context)}
                        ._ toThrowErrorMatchingInlineSnapshot
                            `lit 
                                + "You must provide \`router\` and \`context\` to <StaticRouterProvider>"
            _ it
                @ "handles framework agnostic static handler routes"
                async=> 
                    let frameworkAgnosticRoutes
                        [ 
                            { 
                                @ path "the"
                                @ hasErrorBoundary true
                                [ children
                                    { 
                                        @ path "path"
                                        @ hasErrorBoundary true
                    let 
                        { 
                            @ query
                        = createStaticHandler(frameworkAgnosticRoutes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/the/path"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let frameworkAwareRoutes
                        [ 
                            { 
                                @ path "the"
                                @ element
                                    h1 
                                        + Hi!
                                @ errorElement
                                    h1 
                                        + Error!
                                [ children
                                    { 
                                        @ path "path"
                                        @ element
                                            h2 
                                                + Hi again!
                                        @ errorElement
                                            h2 
                                                + Error again!
                        # This should add route ids + hasErrorBoundary, and also update the
                        # context.matches to include the full framework-aware routes
                    let router = createStaticRouter(frameworkAwareRoutes, context)
                        # This should add route ids + hasErrorBoundary, and also update the
                        # context.matches to include the full framework-aware routes
                    _ expect(router.routes).toMatchInlineSnapshot
                        `lit 
                            + &lf;
                            + &nbsp;     [&lf;
                            + &nbsp;       {&lf;
                            + &nbsp;         "children": [&lf;
                            + &nbsp;           {&lf;
                            + &nbsp;             "children": undefined,&lf;
                            + &nbsp;             "element": <h2>&lf;
                            + &nbsp;               Hi again!&lf;
                            + &nbsp;             </h2>,&lf;
                            + &nbsp;             "errorElement": <h2>&lf;
                            + &nbsp;               Error again!&lf;
                            + &nbsp;             </h2>,&lf;
                            + &nbsp;             "hasErrorBoundary": true,&lf;
                            + &nbsp;             "id": "0-0",&lf;
                            + &nbsp;             "path": "path",&lf;
                            + &nbsp;           },&lf;
                            + &nbsp;         ],&lf;
                            + &nbsp;         "element": <h1>&lf;
                            + &nbsp;           Hi!&lf;
                            + &nbsp;         </h1>,&lf;
                            + &nbsp;         "errorElement": <h1>&lf;
                            + &nbsp;           Error!&lf;
                            + &nbsp;         </h1>,&lf;
                            + &nbsp;         "hasErrorBoundary": true,&lf;
                            + &nbsp;         "id": "0",&lf;
                            + &nbsp;         "path": "the",&lf;
                            + &nbsp;       },&lf;
                            + &nbsp;     ]&lf;
                            + &nbsp;  &nbsp;
                    _ expect(router.state.matches).toMatchInlineSnapshot
                        `lit 
                            + &lf;
                            + &nbsp;     [&lf;
                            + &nbsp;       {&lf;
                            + &nbsp;         "params": {},&lf;
                            + &nbsp;         "pathname": "/the",&lf;
                            + &nbsp;         "pathnameBase": "/the",&lf;
                            + &nbsp;         "route": {&lf;
                            + &nbsp;           "children": [&lf;
                            + &nbsp;             {&lf;
                            + &nbsp;               "children": undefined,&lf;
                            + &nbsp;               "element": <h2>&lf;
                            + &nbsp;                 Hi again!&lf;
                            + &nbsp;               </h2>,&lf;
                            + &nbsp;               "errorElement": <h2>&lf;
                            + &nbsp;                 Error again!&lf;
                            + &nbsp;               </h2>,&lf;
                            + &nbsp;               "hasErrorBoundary": true,&lf;
                            + &nbsp;               "id": "0-0",&lf;
                            + &nbsp;               "path": "path",&lf;
                            + &nbsp;             },&lf;
                            + &nbsp;           ],&lf;
                            + &nbsp;           "element": <h1>&lf;
                            + &nbsp;             Hi!&lf;
                            + &nbsp;           </h1>,&lf;
                            + &nbsp;           "errorElement": <h1>&lf;
                            + &nbsp;             Error!&lf;
                            + &nbsp;           </h1>,&lf;
                            + &nbsp;           "hasErrorBoundary": true,&lf;
                            + &nbsp;           "id": "0",&lf;
                            + &nbsp;           "path": "the",&lf;
                            + &nbsp;         },&lf;
                            + &nbsp;       },&lf;
                            + &nbsp;       {&lf;
                            + &nbsp;         "params": {},&lf;
                            + &nbsp;         "pathname": "/the/path",&lf;
                            + &nbsp;         "pathnameBase": "/the/path",&lf;
                            + &nbsp;         "route": {&lf;
                            + &nbsp;           "children": undefined,&lf;
                            + &nbsp;           "element": <h2>&lf;
                            + &nbsp;             Hi again!&lf;
                            + &nbsp;           </h2>,&lf;
                            + &nbsp;           "errorElement": <h2>&lf;
                            + &nbsp;             Error again!&lf;
                            + &nbsp;           </h2>,&lf;
                            + &nbsp;           "hasErrorBoundary": true,&lf;
                            + &nbsp;           "id": "0-0",&lf;
                            + &nbsp;           "path": "path",&lf;
                            + &nbsp;         },&lf;
                            + &nbsp;       },&lf;
                            + &nbsp;     ]&lf;
                            + &nbsp;  &nbsp;
            _ it
                @ "handles framework agnostic static handler routes (using ErrorBoundary)"
                async=> 
                    let frameworkAgnosticRoutes
                        [ 
                            { 
                                @ path "the"
                                @ hasErrorBoundary true
                                [ children
                                    { 
                                        @ path "path"
                                        @ hasErrorBoundary true
                    let 
                        { 
                            @ query
                        = createStaticHandler(frameworkAgnosticRoutes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/the/path"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let frameworkAwareRoutes
                        [ 
                            { 
                                @ path "the"
                                @ element
                                    h1 
                                        + Hi!
                                @ ErrorBoundary
                                    => 
                                        h1 
                                            + Error!
                                [ children
                                    { 
                                        @ path "path"
                                        @ element
                                            h2 
                                                + Hi again!
                                        @ ErrorBoundary
                                            => 
                                                h2 
                                                    + Error again!
                        # This should add route ids + hasErrorBoundary, and also update the
                        # context.matches to include the full framework-aware routes
                    let router = createStaticRouter(frameworkAwareRoutes, context)
                        # This should add route ids + hasErrorBoundary, and also update the
                        # context.matches to include the full framework-aware routes
                    _ expect(router.routes).toMatchInlineSnapshot
                        `lit 
                            + &lf;
                            + &nbsp;     [&lf;
                            + &nbsp;       {&lf;
                            + &nbsp;         "ErrorBoundary": undefined,&lf;
                            + &nbsp;         "children": [&lf;
                            + &nbsp;           {&lf;
                            + &nbsp;             "ErrorBoundary": undefined,&lf;
                            + &nbsp;             "children": undefined,&lf;
                            + &nbsp;             "element": <h2>&lf;
                            + &nbsp;               Hi again!&lf;
                            + &nbsp;             </h2>,&lf;
                            + &nbsp;             "errorElement": <ErrorBoundary />,&lf;
                            + &nbsp;             "hasErrorBoundary": true,&lf;
                            + &nbsp;             "id": "0-0",&lf;
                            + &nbsp;             "path": "path",&lf;
                            + &nbsp;           },&lf;
                            + &nbsp;         ],&lf;
                            + &nbsp;         "element": <h1>&lf;
                            + &nbsp;           Hi!&lf;
                            + &nbsp;         </h1>,&lf;
                            + &nbsp;         "errorElement": <ErrorBoundary />,&lf;
                            + &nbsp;         "hasErrorBoundary": true,&lf;
                            + &nbsp;         "id": "0",&lf;
                            + &nbsp;         "path": "the",&lf;
                            + &nbsp;       },&lf;
                            + &nbsp;     ]&lf;
                            + &nbsp;  &nbsp;
                    _ expect(router.state.matches).toMatchInlineSnapshot
                        `lit 
                            + &lf;
                            + &nbsp;     [&lf;
                            + &nbsp;       {&lf;
                            + &nbsp;         "params": {},&lf;
                            + &nbsp;         "pathname": "/the",&lf;
                            + &nbsp;         "pathnameBase": "/the",&lf;
                            + &nbsp;         "route": {&lf;
                            + &nbsp;           "ErrorBoundary": undefined,&lf;
                            + &nbsp;           "children": [&lf;
                            + &nbsp;             {&lf;
                            + &nbsp;               "ErrorBoundary": undefined,&lf;
                            + &nbsp;               "children": undefined,&lf;
                            + &nbsp;               "element": <h2>&lf;
                            + &nbsp;                 Hi again!&lf;
                            + &nbsp;               </h2>,&lf;
                            + &nbsp;               "errorElement": <ErrorBoundary />,&lf;
                            + &nbsp;               "hasErrorBoundary": true,&lf;
                            + &nbsp;               "id": "0-0",&lf;
                            + &nbsp;               "path": "path",&lf;
                            + &nbsp;             },&lf;
                            + &nbsp;           ],&lf;
                            + &nbsp;           "element": <h1>&lf;
                            + &nbsp;             Hi!&lf;
                            + &nbsp;           </h1>,&lf;
                            + &nbsp;           "errorElement": <ErrorBoundary />,&lf;
                            + &nbsp;           "hasErrorBoundary": true,&lf;
                            + &nbsp;           "id": "0",&lf;
                            + &nbsp;           "path": "the",&lf;
                            + &nbsp;         },&lf;
                            + &nbsp;       },&lf;
                            + &nbsp;       {&lf;
                            + &nbsp;         "params": {},&lf;
                            + &nbsp;         "pathname": "/the/path",&lf;
                            + &nbsp;         "pathnameBase": "/the/path",&lf;
                            + &nbsp;         "route": {&lf;
                            + &nbsp;           "ErrorBoundary": undefined,&lf;
                            + &nbsp;           "children": undefined,&lf;
                            + &nbsp;           "element": <h2>&lf;
                            + &nbsp;             Hi again!&lf;
                            + &nbsp;           </h2>,&lf;
                            + &nbsp;           "errorElement": <ErrorBoundary />,&lf;
                            + &nbsp;           "hasErrorBoundary": true,&lf;
                            + &nbsp;           "id": "0-0",&lf;
                            + &nbsp;           "path": "path",&lf;
                            + &nbsp;         },&lf;
                            + &nbsp;       },&lf;
                            + &nbsp;     ]&lf;
                            + &nbsp;  &nbsp;
            _ it
                @ "renders absolute links correctly"
                async=> 
                    let routes
                        [ 
                            { 
                                @ path "/"
                                @ element
                                    < React.Fragment
                                        < Link 
                                            @ to "/the/path"
                                            + relative path
                                        < Link 
                                            @ to "http://localhost/the/path"
                                            + absolute same-origin url
                                        < Link 
                                            @ to "https://remix.run"
                                            + absolute different-origin url
                                        < Link 
                                            @ to "mailto:foo@baz.com"
                                            + absolute mailto: url
                    let 
                        { 
                            @ query
                        = createStaticHandler(routes)
                    let context
                        @expr
                            await 
                                _ query
                                    new Request
                                        @ "http://localhost/"
                                        { 
                                            @ signal new AbortController().signal
                            :as 
                                :ref StaticHandlerContext
                    let html
                        _ ReactDOMServer.renderToStaticMarkup
                            < React.StrictMode 
                                < StaticRouterProvider 
                                    @ router {createStaticRouter(routes, context)}
                                    @ context {context}
                    _ expect(html).toMatch('<a href="/the/path">relative path</a>' + '<a href="http://localhost/the/path">absolute same-origin url</a>' + '<a href="https://remix.run">absolute different-origin url</a>' + '<a href="mailto:foo@baz.com">absolute mailto: url</a>')
            _ describe
                @ "boundary tracking"
                => 
                    _ it
                        @ "tracks the deepest boundary during render"
                        async=> 
                            let routes
                                [ 
                                    { 
                                        @ path "/"
                                        @ element
                                            < Outlet 
                                        @ ErrorBoundary
                                            => 
                                                p 
                                                    + Error
                                        [ children
                                            { 
                                                @ index true
                                                @ element
                                                    h1 
                                                        + ðŸ‘‹
                                                @ errorElement
                                                    p 
                                                        + Error
                            let context
                                @expr
                                    await 
                                        _ createStaticHandler(routes).query
                                            new Request
                                                @ "http://localhost/"
                                                { 
                                                    @ signal new AbortController().signal
                                    :as 
                                        :ref StaticHandlerContext
                            let html
                                _ ReactDOMServer.renderToStaticMarkup
                                    < React.StrictMode 
                                        < StaticRouterProvider 
                                            @ router {createStaticRouter(routes, context)}
                                            @ context {context}
                                            @ hydrate {false}
                            _ expect(html).toMatchInlineSnapshot
                                `lit 
                                    + "<h1>ðŸ‘‹</h1>"
                            _ expect(context._deepestRenderedBoundaryId).toBe("0-0")
                    _ it
                        @ "tracks the deepest boundary during render with lazy routes"
                        async=> 
                            let routes
                                [ 
                                    { 
                                        @ path "/"
                                        @ lazy
                                            async=> 
                                                (
                                                    { 
                                                        @ element
                                                            < Outlet 
                                                        @ errorElement
                                                            p 
                                                                + Error
                                        [ children
                                            { 
                                                @ index true
                                                @ lazy
                                                    async=> 
                                                        (
                                                            { 
                                                                @ element
                                                                    h1 
                                                                        + ðŸ‘‹
                                                                @ ErrorBoundary
                                                                    => 
                                                                        p 
                                                                            + Error
                            let 
                                { 
                                    @ query
                                    @ dataRoutes
                                = createStaticHandler(routes)
                            let context
                                @expr
                                    await 
                                        _ query
                                            new Request
                                                @ "http://localhost/"
                                                { 
                                                    @ signal new AbortController().signal
                                    :as 
                                        :ref StaticHandlerContext
                            let html
                                _ ReactDOMServer.renderToStaticMarkup
                                    < React.StrictMode 
                                        < StaticRouterProvider 
                                            @ router {createStaticRouter(dataRoutes, context)}
                                            @ context {context}
                                            @ hydrate {false}
                            _ expect(html).toMatchInlineSnapshot
                                `lit 
                                    + "<h1>ðŸ‘‹</h1>"
                            _ expect(context._deepestRenderedBoundaryId).toBe("0-0")
                    _ it
                        @ "tracks only boundaries that expose an errorElement"
                        async=> 
                            let routes
                                [ 
                                    { 
                                        @ path "/"
                                        @ element
                                            < Outlet 
                                        @ errorElement
                                            p 
                                                + Error
                                        [ children
                                            { 
                                                @ index true
                                                @ element
                                                    h1 
                                                        + ðŸ‘‹
                            let context
                                @expr
                                    await 
                                        _ createStaticHandler(routes).query
                                            new Request
                                                @ "http://localhost/"
                                                { 
                                                    @ signal new AbortController().signal
                                    :as 
                                        :ref StaticHandlerContext
                            let html
                                _ ReactDOMServer.renderToStaticMarkup
                                    < React.StrictMode 
                                        < StaticRouterProvider 
                                            @ router {createStaticRouter(routes, context)}
                                            @ context {context}
                                            @ hydrate {false}
                            _ expect(html).toMatchInlineSnapshot
                                `lit 
                                    + "<h1>ðŸ‘‹</h1>"
                            _ expect(context._deepestRenderedBoundaryId).toBe("0")
                    _ it
                        @ "tracks only boundaries that expose an errorElement with lazy routes"
                        async=> 
                            let routes
                                [ 
                                    { 
                                        @ path "/"
                                        @ lazy
                                            async=> 
                                                (
                                                    { 
                                                        @ element
                                                            < Outlet 
                                                        @ errorElement
                                                            p 
                                                                + Error
                                        [ children
                                            { 
                                                @ index true
                                                @ element
                                                    h1 
                                                        + ðŸ‘‹
                            let 
                                { 
                                    @ query
                                    @ dataRoutes
                                = createStaticHandler(routes)
                            let context
                                @expr
                                    await 
                                        _ query
                                            new Request
                                                @ "http://localhost/"
                                                { 
                                                    @ signal new AbortController().signal
                                    :as 
                                        :ref StaticHandlerContext
                            let html
                                _ ReactDOMServer.renderToStaticMarkup
                                    < React.StrictMode 
                                        < StaticRouterProvider 
                                            @ router {createStaticRouter(dataRoutes, context)}
                                            @ context {context}
                                            @ hydrate {false}
                            _ expect(html).toMatchInlineSnapshot
                                `lit 
                                    + "<h1>ðŸ‘‹</h1>"
                            _ expect(context._deepestRenderedBoundaryId).toBe("0")
